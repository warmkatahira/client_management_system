import{C}from"./chartjs-plugin-datalabels.esm-CglBOSix.js";import{c as w}from"./chart_color-CmXEACsr.js";$(document).ready(function(){T()});function T(){$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:"/client_detail/ajax_get_chart_data",type:"GET",data:{client_id:$("#client_id").val()},dataType:"json",success:function(s){try{const t=document.getElementById("client_sales_chart_div");t.innerHTML="",s.base_clients.forEach(r=>{const a=r.base_client_id,p=r.base_name,o=s.client_sales[a]||[],l=document.createElement("div");l.classList.add("w-full","p-2","bg-white","rounded-2xl","shadow-md","col-span-6"),l.id="client_sales_wrapper_"+a;const i=document.createElement("div");i.classList.add("flex","justify-between","items-center","px-5");const h=document.createElement("p");h.textContent="売上推移("+p+")",h.classList.add("text-base");const c=document.createElement("div");c.classList.add("flex","items-center");const d=document.createElement("select");d.id="termSelect_"+a,d.classList.add("text-sm","rounded-lg"),d.dataset.baseClientId=a;const f=s.term.current_fiscal_term.term_number;for(let e=1;e<=5;e++){const b=f-e,g=document.createElement("option");g.value=b,g.textContent=b+"期",d.appendChild(g)}const _=document.createElement("button");_.classList.add("btn","bg-btn-enter","text-white","rounded-lg","px-5","py-2","add_term_button","mr-5","ml-2"),_.textContent="追加",_.dataset.baseClientId=a,c.appendChild(d),c.appendChild(_),i.appendChild(h),i.appendChild(c);const n=document.createElement("button");n.type="button",n.classList.add("btn","chart_type_change","border","border-black","p-1","tippy_line_chart","bg-theme-sub-y"),n.innerHTML='<img src="/icon/line_chart.svg" class="w-6 h-6">',n.dataset.baseClientId=a,n.dataset.chartType="line",tippy(n,{content:"折れ線グラフで表示",duration:500,allowHTML:!0,placement:"right",theme:"tippy_main_theme"});const m=document.createElement("button");m.type="button",m.classList.add("btn","chart_type_change","border-y","border-r","border-black","p-1","tippy_bar_chart"),m.innerHTML='<img src="/icon/bar_chart.svg" class="w-6 h-6">',m.dataset.baseClientId=a,m.dataset.chartType="bar",tippy(m,{content:"棒グラフで表示",duration:500,allowHTML:!0,placement:"right",theme:"tippy_main_theme"}),c.appendChild(n),c.appendChild(m),l.appendChild(i);const y=document.createElement("canvas");y.id="client_sales_chart_"+a,y.classList.add("w-full","bg-white"),y.height=300,l.appendChild(y),t.appendChild(l);const v=Array.from({length:12},(e,b)=>(b+9)%12+1+"月"),E=x(o,a),L=y.getContext("2d");new C(L,{data:{labels:v,datasets:E},options:{responsive:!1,scales:{"y-axis-1":{type:"linear",position:"left",ticks:{max:5e7,min:0,stepSize:5e5}},x:{offset:!0}},animation:{onProgress:e=>{console.log(e.currentStep/e.numSteps)},delay:e=>e.dataIndex*80},plugins:{legend:{labels:{usePointStyle:!0}},tooltip:{callbacks:{title:function(e){return e[0].dataset.yearMonthJp[e[0].dataIndex]},label:function(e){return e.formattedValue+"円"}},bodyFont:{size:16},titleFont:{size:18},padding:12,boxPadding:6}}}})})}catch{alert("グラフの生成に失敗しました。")}},error:function(){alert("グラフの生成に失敗しました。")}})}function x(u,s){var c,d,f;const t=C.getChart("client_sales_chart_"+s),r=Object.values(w),a=t?t.data.datasets.length:0,p=r[a%r.length];let o=[],l=[];const i=u[0].term_number;if(t&&t.data.datasets.some(n=>n.term_number===i))return[];$.each(u,function(_,n){o.push(n.amount),l.push(n.year_month_jp)});const h=[];if(o.length>0){const _=((f=(d=(c=t==null?void 0:t.data)==null?void 0:c.datasets)==null?void 0:d[0])==null?void 0:f.type)??"line";h.push({type:_,label:i+"期",data:o,borderColor:p.borderColor,backgroundColor:p.backgroundColor,pointBackgroundColor:p.borderColor,pointRadius:5,pointHoverRadius:7,yAxisID:"y-axis-1",yearMonthJp:l,term_number:i,borderRadius:30,fill:!0,tension:.4})}return h}$(document).on("click",".add_term_button",function(){const u="/client_detail/ajax_get_sales_data",s=$(this).data("base-client-id");$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:u,type:"GET",data:{client_id:$("#client_id").val(),term_number:$("#termSelect_"+s).val(),base_client_id:s},dataType:"json",success:function(t){try{const r=t.client_sales[t.base_client_id]||[];if(r.length===0)return;const a="client_sales_chart_"+t.base_client_id,p=x(r,t.base_client_id),o=C.getChart(a);o.data.datasets.push(...p),o.update()}catch{alert("グラフの生成に失敗しました。")}},error:function(){alert("グラフの生成に失敗しました。")}})});$(document).on("click",".chart_type_change",function(){const u=$(this).data("chart-type"),s=$(this).data("base-client-id"),t=C.getChart("client_sales_chart_"+s);t.data.datasets.forEach(r=>{r.type=u}),t.update(),$(`#client_sales_wrapper_${s} .chart_type_change`).removeClass("bg-theme-sub-y"),$(this).addClass("bg-theme-sub-y")});
