import{C}from"./chartjs-plugin-datalabels.esm-CglBOSix.js";import{c as L}from"./chart_color-CmXEACsr.js";$(document).ready(function(){j()});function j(){$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:"/client_detail/ajax_get_chart_data",type:"GET",data:{client_id:$("#client_id").val()},dataType:"json",success:function(n){try{const t=document.getElementById("client_sales_chart_div");t.innerHTML="",n.base_clients.forEach(a=>{const e=a.base_client_id,h=a.base_name,l=n.client_sales[e]||[],o=document.createElement("div");o.classList.add("w-full","p-2","bg-white","rounded-2xl","shadow-md","col-span-6"),o.id="client_sales_wrapper_"+e;const d=document.createElement("div");d.classList.add("flex","justify-between","items-center","px-5");const p=document.createElement("p");p.textContent="売上推移("+h+")",p.classList.add("text-base");const i=document.createElement("div");i.classList.add("flex","items-center");const s=document.createElement("select");s.id="yearSelect_"+e,s.classList.add("text-sm","rounded-lg"),s.dataset.baseClientId=e;const x=new Date().getFullYear();for(let c=1;c<=5;c++){const m=x-c,g=document.createElement("option");g.value=m,g.textContent=m+"年",s.appendChild(g)}const y=document.createElement("button");y.classList.add("btn","bg-btn-enter","text-white","rounded-lg","px-5","py-2","add_year_button","mr-5","ml-2"),y.textContent="追加",y.dataset.baseClientId=e,i.appendChild(s),i.appendChild(y),d.appendChild(p),d.appendChild(i);const _=document.createElement("button");_.type="button",_.classList.add("btn","chart_type_change","border","border-black","p-1","bg-theme-sub-y"),_.innerHTML='<img src="/icon/line_chart.svg" class="w-6 h-6">',_.dataset.baseClientId=e,_.dataset.chartType="line";const u=document.createElement("button");u.type="button",u.classList.add("btn","chart_type_change","border-y","border-r","border-black","p-1"),u.innerHTML='<img src="/icon/bar_chart.svg" class="w-6 h-6">',u.dataset.baseClientId=e,u.dataset.chartType="bar",i.appendChild(_),i.appendChild(u),o.appendChild(d);const b=document.createElement("canvas");b.id="client_sales_chart_"+e,b.classList.add("w-full","bg-white"),b.height=300,o.appendChild(b),t.appendChild(o);const v=Array.from({length:12},(c,m)=>m+1+"月"),E=f(l,e),w=b.getContext("2d");new C(w,{type:"line",data:{labels:v,datasets:E},options:{responsive:!1,scales:{"y-axis-1":{type:"linear",position:"left",ticks:{max:1e8,min:0,stepSize:1e6}}},plugins:{legend:{labels:{usePointStyle:!0}},tooltip:{callbacks:{title:function(c){return c[0].dataset.yearMonthJp[c[0].dataIndex]},label:function(c){return c.formattedValue+"円"}},bodyFont:{size:16},titleFont:{size:18},padding:12,boxPadding:6}}}})})}catch{alert("グラフの生成に失敗しました。")}},error:function(){alert("グラフの生成に失敗しました。")}})}function f(r,n){const t=C.getChart("client_sales_chart_"+n),a=Object.values(L),e=t?t.data.datasets.length:0,h=a[e%a.length];let l=[],o=[];const d=r.length===0?"":r[0].year_month.split("-")[0];if(t&&t.data.datasets.some(s=>s.year===d))return[];$.each(r,function(i,s){l.push(s.amount),o.push(s.year_month_jp)});const p=[];return l.length>0&&p.push({type:"line",label:d+"年",data:l,borderColor:h.borderColor,backgroundColor:h.backgroundColor,pointBackgroundColor:h.borderColor,pointRadius:5,pointHoverRadius:7,yAxisID:"y-axis-1",yearMonthJp:o,year:d}),p}$(document).on("click",".add_year_button",function(){const r="/client_detail/ajax_get_sales_data",n=$(this).data("base-client-id");$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:r,type:"GET",data:{client_id:$("#client_id").val(),year:$("#yearSelect_"+n).val(),base_client_id:n},dataType:"json",success:function(t){try{const a=t.client_sales[t.base_client_id]||[];if(a.length===0)return;const e="client_sales_chart_"+t.base_client_id,h=f(a,t.base_client_id),l=C.getChart(e);l.data.datasets.push(...h),l.update()}catch{alert("グラフの生成に失敗しました。")}},error:function(){alert("グラフの生成に失敗しました。")}})});$(document).on("click",".chart_type_change",function(){const r=$(this).data("chart-type"),n=$(this).data("base-client-id"),t=C.getChart("client_sales_chart_"+n);t.data.datasets.forEach(a=>{a.type=r}),t.update(),$(`#client_sales_wrapper_${n} .chart_type_change`).removeClass("bg-theme-sub-y"),$(this).addClass("bg-theme-sub-y")});
